# Billing Service

## Типы пользователей в системе
- администратор
- зарегистрированный пользователь

## Сущности
* Продукт - подписка на библиотеку фильмов и сериалов, подписка на единицу контента, единица контента (подписка навсегда?)
* Заказ - набор из 1 и более продуктов
* Продукт в заказе. В этой сущности можно переопределять стоимость продукта (например, с помощью применения промокода в будущем)
* Продукт пользователя. Сущность для хранения доп информации о продукте, который приобрел пользователь (даты начала и окончания действия подписки)
* Транзакция - информация об оплате заказа. У заказа может быть несколько транзакций со статусом отличным от success, если в процессе оплаты возникнут проблемы
* Способ оплаты пользователя. Сущность, хранящая платежные данные пользователя для автоматических платежей

## Функциональные требования
Для всех CREATE, UPDATE, DELETE операций нужно строго проверять валидность access токена
(проверять, не был ли выполнен выход со всех устройств или с помощью этого токена в auth сервисе)

### Зарегистрированный пользователь
* Создание заказа
* Оплата заказа (переход по сгенерированной ссылке на платежный шлюз)
* Отмена авто-продления подписки
* Просмотр активных купленных продуктов
* Просмотр истории заказов

### Администратор (Зарегистрированный пользователь)
* CRUD продуктов
* Оформление возврата (указывается id заказа или продуктов для автоматического изъятия продукта)

### Автоматические действия системы
- авто-продление подписок
- получение и обработка результатов транзакций от платежного шлюза
- начисление продуктов из оплаченных заказов пользователю
- отправка уведомлений о результатах оплаты

## Нефункциональные требования
- устойчивость к перебоям (обработка исключений + backoff)
- идемпотентность запросов (использование uuid как ключа идемпотентности при запросах к платежному шлюзу)
- гарантия exectly once для платежей
- время отклика должно быть не более 300 мс (95-й перцентиль)
- 